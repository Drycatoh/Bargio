<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>title</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
	<script src="easytimer.js"></script>
  </head>
  
  <body>
	<h1 id="chargement">Chargement initial...</h1>
	<div id="fin_chargement" style="display:none;">
	<label style="color:darkgreen;">Synchronisé</label>
	<label style="color:darkred;display:none;">Désynchronisé</label>
    </br>
	</br>
	<label id="timer">00:00:00</label><label> avant la prochaîne requête</label>
	</br>
	</br>
	<button id="ajouter" type="button">Ajouter opération</button>
	</br>
	</br>
	<textarea id="historique" cols="100" rows="20">
1x F5 à 1.25€ sur 1Test217 (solde restant : 5€)
1x F1 à 0.80€ sur 1Test217 (solde restant : 4.20€)
</textarea>
	<textarea id="debug" cols="100" rows="20"></textarea>
	
	<script>
	$( document ).ready(function() {	
		// Créée les tables de bdd locales :
		// - UserData : sera chargée depuis le serveur,
		// contient chaque PG, son solde et son statut (hors babasse...)
		// - HistoriqueTransactions : table à synchroniser, contient tout l'historique
		// des transactions, bucquages comme rechargement
		var db = new Dexie("db");
		db.version(1).stores({
			UserData: 'UserName,HorsFoys,Solde,'
			+ 'FoysApiHasPassword,FoysApiPasswordHash,'
			+ 'FoysApiPasswordSalt',
			HistoriqueTransactions: '++,UserName,Date,Montant,IdProduit,Commentaire'
		});
		db.open().catch (function (err) {
			console.error('Failed to open db: ' + (err.stack || err));
		});
	
		function foysApiGet() {
			$.ajax({
                type: 'GET',
                url: '/Api/Foys',
                success: function (response) {
                    JSON.parse(response).forEach(function(user) {
						db.UserData.add(user);
					});
					$("#debug").val(db.UserData.toArray());
                }
            });
		}
	
		// Chargement
		$("#chargement").hide();
		foysApiGet();
		$("#fin_chargement").show();
		
		$("#ajouter").click(function(){
			// On ajoute une transaction random
			// product id, montant, utilisateur, commentaire
			var textArray = [
				[1,1.25,"1Test217"],
				[2,2.50,"1Test217"],
				[3,3.75,"1Test217"],
				[4,5.00,"1Test217"]
			];
			
			var randomNumber = Math.floor(Math.random()*textArray.length);
			var commentaire = "Id produit " + textArray[randomNumber][0]
				+ ", Prix = " + textArray[randomNumber][1] 
				+ "€, sur " + textArray[randomNumber][2] + "\n";
			
			$("#historique").val($("#historique").val() + commentaire);			
				
		});
		
		var timer = new Timer();
		timer.start({countdown: true, startValues: {seconds: 5}});
		timer.addEventListener('secondsUpdated', function (e) {
			$('#timer').html(timer.getTimeValues().toString());
		});
		timer.addEventListener('targetAchieved', function (e) {
			timer.reset();
			
		});
       
	});
	</script>
	
  </body>
</html>